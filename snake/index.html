<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Power Outage Snake</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: #ffffff;
            --cell-bg: #d3d4d5;
            --label-bg: #ffbb42;
            --text-main: var(--tg-theme-text-color, #000000);
            --bg-color: var(--tg-theme-bg-color, #f0f2f5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 7px; display: flex; flex-direction: column;
            align-items: center; background-color: var(--bg-color); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh; overflow: hidden;
        }

        #header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin: 10px 0; max-width: 600px; }
        .header-left { display: flex; flex-direction: column; gap: 2px; }
        .title { font-weight: 800; font-size: 1.1rem; color: var(--text-main); line-height: 1.2; }
        .date-label { background-color: var(--label-bg); color: #000; font-weight: bold; padding: 2px 8px; font-size: 0.9rem; display: inline-block; border-radius: 4px; }
        .header-logo { height: 2.4rem; width: auto; object-fit: contain; }

        #game-wrapper { position: relative; display: flex; flex-direction: column; background: #fff; padding: 5px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        #live-score {
            align-self: flex-end;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80px; 
            height: 24px;
            background: var(--cell-bg);
            color: #000;
            border-radius: 20px;
            font-weight: 900;
            font-family: 'Courier New', Courier, monospace; 
            font-size: 0.9rem;
            font-variant-numeric: tabular-nums;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #ccc;
            padding: 0; 
            overflow: hidden;
        }

        #col-headers { display: flex; margin-left: 25px; margin-bottom: 5px; }
        .col-label { font-size: 8px; text-align: center; writing-mode: vertical-rl; transform: rotate(180deg); color: #666; display: flex; align-items: center; justify-content: center; font-family: monospace; }
        #main-area { display: flex; flex-direction: row; }
        #row-headers { display: flex; flex-direction: column; width: 25px; justify-content: space-around; padding-right: 4px; }
        .row-label { background-color: var(--label-bg); color: #000; font-size: 8px; font-weight: bold; border-radius: 6px; display: flex; align-items: center; justify-content: center; height: 18px; font-family: monospace; }
        canvas { display: block; border: 1px solid #ccc; background-color: var(--cell-bg); }

        #ui-middle-section { width: 100%; max-width: 300px; margin: 10px 0; text-align: center; font-family: monospace;}
        #greeting { font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; color: var(--text-main); }
        .lb-container { background: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1); }
        .lb-title { font-weight: 800; font-size: 0.75rem; color: #666; border-bottom: 1px solid #ccc; margin-bottom: 5px; padding-bottom: 3px; display: flex; justify-content: space-between; align-items: center;}
        
        #lb-content { transition: opacity 0.3s ease; }
        .lb-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 2px 0; color: var(--text-main); animation: fadeIn 0.4s ease; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; border-radius: 5px; z-index: 10; color: white; }
        #overlay h2 { margin: 0; font-size: 1.5rem; color: var(--label-bg); }
        .overlay-buttons { display: flex; gap: 10px; margin-top: 15px; }
        #overlay button { background: var(--label-bg); border: none; padding: 10px 20px; font-weight: bold; border-radius: 8px; font-size: 1rem; color: #000; cursor: pointer; transition: transform 0.1s;}
        #overlay button:active { transform: scale(0.95); }
        #overlay button.share-btn { background: #3390ec; color: white; }

        #controls { 
            margin-top: auto; 
            margin-bottom: 10px; 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            width: 100%; 
            max-width: 250px; 
        }

        .btn { 
            aspect-ratio: 1/1; 
            background: radial-gradient(circle at 50% 60%, #1e3d2b 0%, #142b1e 100%); 
            border-radius: 15px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 4px #0a1610;
            user-select: none;
            transition: all 0.05s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn::before {
            content: ''; display: block; width: 24px; height: 24px; background-color: #ccc;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            filter: drop-shadow(0 2px 1px rgba(0,0,0,0.4));
            transition: background-color 0.1s;
        }
        
        .up::before    { transform: rotate(0deg); }
        .down::before  { transform: rotate(180deg); }
        .left::before  { transform: rotate(-90deg); }
        .right::before { transform: rotate(90deg); }

        .btn:active, .btn.pressed { 
            transform: translateY(3px); 
            box-shadow: 0 1px #050a07; 
            background: radial-gradient(circle at 50% 60%, #2a523a 0%, #1e3d2b 100%);
        }

        .btn:active::before { filter: drop-shadow(0 1px 0px rgba(0,0,0,0.6)); border-bottom-color: #aaa; }	
    </style>
</head>
<body>

<div id="header">
    <div class="header-left">
        <div class="title">–ì—Ä–∞—Ñ—ñ–∫ –ø–æ–≥–æ–¥–∏–Ω–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å</div>
        <div class="date-container"><span class="date-label" id="today-date">--.--.----</span></div>
    </div>
    <img src="header-logo.svg" class="header-logo" alt="logo" onerror="this.style.display='none'">
</div>

<div id="game-wrapper">
    <div id="live-score">üí°: 0</div>    
    <div id="overlay">
        <h2>–ì—Ä–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–∞</h2>
        <p>–í–∞—à —Ä–∞—Ö—É–Ω–æ–∫: <span id="final-score">0</span></p>
        <div class="overlay-buttons">
            <button onclick="resetGame()">–ó–Ω–æ–≤—É</button>
            <button class="share-btn" onclick="shareScore()">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>
        </div>
    </div>
    <div id="col-headers"></div>
    <div id="main-area">
        <div id="row-headers"></div>
        <canvas id="gameCanvas"></canvas>
    </div>
</div>

<div id="ui-middle-section">
    <div id="greeting">–ü—Ä–∏–≤—ñ—Ç! –î–∞–≤–∞–π —Å–ø—Ä–æ–±—É—î–º–æ —É–≤—ñ–π—Ç–∏ –≤ –¢–û–ü-5</div>
    <div class="lb-container">
        <div class="lb-title">–¢–û–ü 5 –ì–†–ê–í–¶–Ü–í <span id="lb-loader" style="display:none; font-size:10px; color:#999;">(–æ–Ω–æ–≤–ª–µ–Ω–Ω—è...)</span></div>
        <div id="lb-content">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
    </div>
</div>

<div id="controls">
    <div class="btn up" style="grid-column:2" onpointerdown="changeDir('UP')"></div>
    <div class="btn left" style="grid-column:1" onpointerdown="changeDir('LEFT')"></div>
    <div class="btn down" style="grid-column:2" onpointerdown="changeDir('DOWN')"></div>
    <div class="btn right" style="grid-column:3" onpointerdown="changeDir('RIGHT')"></div>
</div>

<script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxr9OemBs-vGeQPGzK1VkPinTDKqCyn_iSRM0Yy5ISYxx3BsJUSdaPelikII6l-lKYeUQ/exec"; 

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let playerName = "–ì—Ä–∞–≤–µ—Ü—å";
    let userId = "0";

    function updatePlayerName() {
        const user = tg.initDataUnsafe?.user;
        if (user) {
            userId = String(user.id);
            playerName = user.first_name || "–ì—Ä–∞–≤–µ—Ü—å";
            if (user.last_name) playerName += " " + user.last_name;
        }
        document.getElementById('greeting').innerText = `–ü—Ä–∏–≤—ñ—Ç, ${playerName}!\nC–ø—Ä–æ–±—É–π —É–≤—ñ–π—Ç–∏ –≤ —Å—É—Å—ñ–¥—Å—å–∫–∏–π –¢–û–ü-5`;
    }
    updatePlayerName();

    document.getElementById('today-date').innerText = new Date().toLocaleDateString('uk-UA');

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const ROWS = 12, COLS = 24;
    
    const availableWidth = window.innerWidth - 40;
    const availableHeight = window.innerHeight - 380; 
    const CELL_SIZE = Math.min(Math.floor(availableWidth / COLS), Math.floor(availableHeight / ROWS), 25);
    const SVG_SIZE = Math.floor(CELL_SIZE * 0.65);

    canvas.width = COLS * CELL_SIZE; canvas.height = ROWS * CELL_SIZE;

    const iconOff = new Image(); iconOff.src = 'elec-off.svg';
    const iconOn = new Image(); iconOn.src = 'elec-on.svg';

    const colHeaderDiv = document.getElementById('col-headers');
    for(let i=0; i<COLS; i++) {
        const d = document.createElement('div'); d.className = 'col-label';
        d.style.width = CELL_SIZE + 'px';
        d.innerText = `${i.toString().padStart(2, '0')}-${(i+1).toString().padStart(2, '0')}`;
        colHeaderDiv.appendChild(d);
    }
    const rowHeaderDiv = document.getElementById('row-headers');
    for(let i=1; i<=6; i++) {
        [".1", ".2"].forEach(sub => {
            const d = document.createElement('div'); d.className = 'row-label';
            d.innerText = i + sub; d.style.height = (CELL_SIZE - 2) + 'px';
            rowHeaderDiv.appendChild(d);
        });
    }

    let snake = [{x: 5, y: 5}, {x: 4, y: 5}], food = {x: 12, y: 6};
    let dx = 1, dy = 0, nextDir = 'RIGHT', score = 0, isGameOver = false;
    let actionLocked = false;

    const BASE_SPEED = 5;
    const MAX_SPEED = 20; 
    let currentSpeed = BASE_SPEED;

    function renderLeaderboard(data) {
        const lbBox = document.getElementById('lb-content');
        if (!data || data.length === 0) {
            lbBox.innerHTML = "–ü–æ–∫–∏ –Ω–µ–º–∞—î —Ä–µ–∫–æ—Ä–¥—ñ–≤";
            return;
        }
        lbBox.innerHTML = data.map((row, i) => `
            <div class="lb-row">
                <span>${i+1}. ${row[0]}</span>
                <b>${row[1]}</b>
            </div>
        `).join('');
    }

    async function fetchLeaderboard() {
        try {
            const res = await fetch(SHEET_URL);
            const data = await res.json();
            renderLeaderboard(data);
        } catch (e) { document.getElementById('lb-content').innerHTML = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"; }
    }

    async function submitScoreAndFetch() {
        const lbBox = document.getElementById('lb-content');
        const loader = document.getElementById('lb-loader');
        
        loader.style.display = 'inline';
        lbBox.style.opacity = '0.5';

        try {
            const res = await fetch(SHEET_URL, {
                method: 'POST',
                body: JSON.stringify({ userId: userId, name: playerName, score: score }),
                headers: { 'Content-Type': 'text/plain' }
            });
            const text = await res.text();
            const data = JSON.parse(text);
            renderLeaderboard(data);
        } catch (e) { 
            console.error("Score submission failed", e);
            fetchLeaderboard();
        } finally {
            loader.style.display = 'none';
            lbBox.style.opacity = '1';
        }
    }

    fetchLeaderboard();
	
	async function shareScore() {
    const botUrl = "https://t.me/AvalonZelenaElectricity_bot/pos"; 
    const textMessage = `–Ø –∑—ñ–±—Ä–∞–≤ ${score} üí°!\n–°–ø—Ä–æ–±—É–π –ø–æ–±–∏—Ç–∏ –º—ñ–π —Ä–µ–∫–æ—Ä–¥\n—É —Å—É—Å—ñ–¥—Å—å–∫–æ–º—É –∑–º–∞–≥–∞–Ω–Ω—ñ!`;
    const fullText = `${textMessage}\n\n–ì—Ä–∞—Ç–∏ —Ç—É—Ç: ${botUrl}`;

    if (navigator.share && navigator.canShare) {
        try {
            const canvas = document.getElementById("gameCanvas");
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            const file = new File([blob], 'snake_score.png', { type: 'image/png' });
            if (navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: '–ú—ñ–π —Ä–µ–∫–æ—Ä–¥ —É –ó–º—ñ–π—Ü—ñ!',
                    text: fullText,
                    files: [file]
                });
                return;
            }
        } catch (error) {
            console.warn("–®–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å–∫–∞—Å–æ–≤–∞–Ω–æ –∞–±–æ –Ω–µ –≤–¥–∞–≤—Å—è:", error);
            if (error.name !== 'AbortError') {
                fallbackShare();
            }
            return;
        }
    }

    fallbackShare();

    function fallbackShare() {
        const botUrl = "https://t.me/AvalonZelenaElectricity_bot/pos"; 
        const text = `–Ø –∑—ñ–±—Ä–∞–≤ ${score} üí°!\n–°–ø—Ä–æ–±—É–π –ø–æ–±–∏—Ç–∏ –º—ñ–π —Ä–µ–∫–æ—Ä–¥\n—É —Å—É—Å—ñ–¥—Å—å–∫–æ–º—É –∑–º–∞–≥–∞–Ω–Ω—ñ!`;
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(botUrl)}&text=${encodeURIComponent(text)}`;
        tg.openTelegramLink(shareUrl);
    }
}

    function draw() {
        ctx.fillStyle = "#d3d4d5"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        const iconOffset = (CELL_SIZE - SVG_SIZE) / 2;
        ctx.strokeStyle = "rgba(255,255,255,0.4)";
        for (let x = 0; x < COLS; x++) {
            for (let y = 0; y < ROWS; y++) {
                ctx.strokeRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                if (iconOff.complete && (x !== food.x || y !== food.y)) 
                    ctx.drawImage(iconOff, x * CELL_SIZE + iconOffset, y * CELL_SIZE + iconOffset, SVG_SIZE, SVG_SIZE);
            }
        }
        ctx.font = `${CELL_SIZE * 0.8}px serif`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText("üí°", food.x * CELL_SIZE + CELL_SIZE/2, food.y * CELL_SIZE + CELL_SIZE/2 + 2);
        snake.forEach(p => {
            ctx.fillStyle = "#ffffff"; ctx.fillRect(p.x * CELL_SIZE, p.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            if (iconOn.complete) ctx.drawImage(iconOn, p.x * CELL_SIZE + iconOffset, p.y * CELL_SIZE + iconOffset, SVG_SIZE, SVG_SIZE);
        });
    }

    function update() {
        if (nextDir === 'LEFT' && dx === 0) { dx = -1; dy = 0; }
        if (nextDir === 'RIGHT' && dx === 0) { dx = 1; dy = 0; }
        if (nextDir === 'UP' && dy === 0) { dx = 0; dy = -1; }
        if (nextDir === 'DOWN' && dy === 0) { dx = 0; dy = 1; }
        
        actionLocked = false;

        const head = {x: (snake[0].x + dx + COLS) % COLS, y: (snake[0].y + dy + ROWS) % ROWS};
        
        if (snake.some(p => p.x === head.x && p.y === head.y)) { 
            handleGameOver(); 
            return; 
        }
        
        snake.unshift(head);
        
        if (head.x === food.x && head.y === food.y) {
            score++;
            document.getElementById('live-score').innerText = `üí°: ${score}`;
            try { tg.HapticFeedback.impactOccurred('medium'); } catch(e){}
            
            currentSpeed = Math.min(BASE_SPEED + (score * 0.05), MAX_SPEED);
            
            let newFood;
            while (true) {
                newFood = { 
                    x: Math.floor(Math.random() * COLS), 
                    y: Math.floor(Math.random() * ROWS) 
                };
                if (!snake.some(segment => segment.x === newFood.x && segment.y === newFood.y)) break; 
            }
            food = newFood;
        } else { 
            snake.pop(); 
        }
    }

    function handleGameOver() {
        isGameOver = true;
        try { tg.HapticFeedback.notificationOccurred('warning'); } catch(e){}
        document.getElementById('final-score').innerText = score;
        document.getElementById('overlay').style.display = 'flex';
        submitScoreAndFetch();
    }

    function resetGame() {
        snake = [{x: 5, y: 5}, {x: 4, y: 5}]; 
        dx = 1; dy = 0; nextDir = 'RIGHT'; score = 0;
        currentSpeed = BASE_SPEED;
        actionLocked = false;

        document.getElementById('live-score').innerText = `üí°: 0`; 
        document.getElementById('overlay').style.display = 'none';
        
        let newFood;
        while (true) {
            newFood = { x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS) };
            if (!snake.some(s => s.x === newFood.x && s.y === newFood.y)) break;
        }
        food = newFood;
        isGameOver = false;
        lastRenderTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    function changeDir(d) { 
        if(isGameOver || actionLocked) return; 
        
        if (d === 'UP' && dy === 0) { nextDir = d; actionLocked = true; }
        if (d === 'DOWN' && dy === 0) { nextDir = d; actionLocked = true; }
        if (d === 'LEFT' && dx === 0) { nextDir = d; actionLocked = true; }
        if (d === 'RIGHT' && dx === 0) { nextDir = d; actionLocked = true; }
    }
    
    window.addEventListener('keydown', e => { 
        if(e.key.includes('Arrow')) changeDir(e.key.replace('Arrow', '').toUpperCase()); 
    });

    let lastRenderTime = 0;
    
    function gameLoop(currentTime) {
        if (isGameOver) return;
        window.requestAnimationFrame(gameLoop);
        const secondsSinceLastRender = (currentTime - lastRenderTime) / 1000;
        
        if (secondsSinceLastRender < 1 / currentSpeed) return;
        
        lastRenderTime = currentTime;
        update(); 
        draw();
    }
    window.requestAnimationFrame(gameLoop);
</script>
</body>
</html>
