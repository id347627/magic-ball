<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Power Outage Snake</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: #ffffff;
            --cell-bg: #d3d4d5;
            --label-bg: #ffbb42;
            --text-main: #000000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 7px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--tg-theme-bg-color, #f0f2f5);
            color: var(--tg-theme-text-color, #000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
			margin-top: 20px;
            max-width: 600px;
        }

        .header-left { display: flex; flex-direction: column; gap: 2px; }
        .title { font-weight: 800; font-size: 1.1rem; color: var(--text-main); line-height: 1.2; }
        .date-container { display: block; }
        .date-label {
            background-color: var(--label-bg);
            color: #000;
            font-weight: bold;
            padding: 2px 8px;
            font-size: 0.9rem;
            display: inline-block;
            box-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            line-height: 1.2;
            border-radius: 4px;
        }

        .header-logo { height: 2.4rem; width: auto; object-fit: contain; }

        #game-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            background: #fff;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        #col-headers { display: flex; margin-left: 45px;  padding-bottom: 5px;}
        .col-label {
            font-size: 10px;
            text-align: center;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'ui-monospace', 'SFMono-Regular', monospace;
            font-variant-numeric: tabular-nums;
           
        }

        #main-area { display: flex; flex-direction: row; }
        #row-headers { display: flex; flex-direction: column; width: 45px; justify-content: space-around; padding-right: 4px; }
        .row-label {
            background-color: var(--label-bg);
            color: #000;
            font-size: 10px;
            font-weight: bold;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 18px;
            font-family: 'ui-monospace', 'SFMono-Regular', monospace;
            font-variant-numeric: tabular-nums;
        }

        canvas { display: block; border: 1px solid #ccc; background-color: var(--cell-bg); }

        /* Game Over Overlay */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 10;
            color: white;
            text-align: center;
        }
        #overlay h2 { margin: 0; font-size: 1.5rem; color: var(--label-bg); }
        #overlay p { margin: 10px 0; font-size: 1.2rem; }
        #overlay button {
            background: var(--label-bg);
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        #controls {
            margin-top: auto;
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 250px;
        }

        .btn {
            aspect-ratio: 1/1;
            background: #e0e0e0;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            user-select: none;
            box-shadow: 0 4px #bbb;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px #999; }
    </style>
</head>
<body>

<div id="header">
    <div class="header-left">
        <div class="title">Ð“Ñ€Ð°Ñ„Ñ–Ðº Ð¿Ð¾Ð³Ð¾Ð´Ð¸Ð½Ð½Ð¸Ñ… Ð²Ñ–Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½ÑŒ </div>
        <div class="date-container">
            <span class="date-label" id="today-date">--.--.----</span>
        </div>
    </div>
    <img src="header-logo.svg" class="header-logo" alt="logo">
</div>

<div id="game-wrapper">
    <div id="overlay">
        <h2>Ð“Ñ€Ð° Ð·Ð°ÐºÑ–Ð½Ñ‡ÐµÐ½Ð°</h2>
        <p>Ð Ð°Ñ…ÑƒÐ½Ð¾Ðº: <span id="final-score">0</span></p>
        <button onclick="reset()">Ð—Ð½Ð¾Ð²Ñƒ</button>
    </div>
    <div id="col-headers"></div>
    <div id="main-area">
        <div id="row-headers"></div>
        <canvas id="gameCanvas"></canvas>
    </div>
</div>

<div id="controls">
    <div class="btn" style="grid-column:2" onpointerdown="changeDir('UP')">â–²</div>
    <div class="btn" style="grid-column:1" onpointerdown="changeDir('LEFT')">â—€</div>
    <div class="btn" style="grid-column:2" onpointerdown="changeDir('DOWN')">â–¼</div>
    <div class="btn" style="grid-column:3" onpointerdown="changeDir('RIGHT')">â–¶</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    const now = new Date();
    document.getElementById('today-date').innerText = now.toLocaleDateString('uk-UA');

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const ROWS = 12;
    const COLS = 24;
    
    const availableWidth = window.innerWidth - 80;
    const availableHeight = window.innerHeight - 250; 
    const CELL_SIZE = Math.min(Math.floor(availableWidth / COLS), Math.floor(availableHeight / ROWS), 25);
    const SVG_SIZE = Math.floor(CELL_SIZE * 0.65);

    canvas.width = COLS * CELL_SIZE;
    canvas.height = ROWS * CELL_SIZE;

    const iconOff = new Image(); iconOff.src = 'elec-off.svg';
    const iconOn = new Image(); iconOn.src = 'elec-on.svg';

    const rowNames = [];
    for(let i=1; i<=6; i++) rowNames.push(`${i}.1`, `${i}.2`);

    const colHeaderDiv = document.getElementById('col-headers');
    for(let i=0; i<24; i++) {
        const d = document.createElement('div');
        d.className = 'col-label';
        d.style.width = CELL_SIZE + 'px';
        d.innerText = `${i.toString().padStart(2, '0')}-${(i+1).toString().padStart(2, '0')}`;
        colHeaderDiv.appendChild(d);
    }

    const rowHeaderDiv = document.getElementById('row-headers');
    rowNames.forEach(name => {
        const d = document.createElement('div');
        d.className = 'row-label';
        d.innerText = name;
        d.style.height = (CELL_SIZE - 2) + 'px';
        rowHeaderDiv.appendChild(d);
    });

    let snake = [{x: 5, y: 5}, {x: 4, y: 5}];
    let food = {x: 12, y: 6};
    let dx = 1, dy = 0, nextDir = 'RIGHT', score = 0, isGameOver = false;

    function draw() {
        ctx.fillStyle = "#d3d4d5";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const iconOffset = (CELL_SIZE - SVG_SIZE) / 2;

        for (let x = 0; x < COLS; x++) {
            for (let y = 0; y < ROWS; y++) {
                ctx.strokeStyle = "rgba(255,255,255,0.4)";
                ctx.strokeRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                
                // Only draw elec-off if this isn't where the bulb is
                if (iconOff.complete && (x !== food.x || y !== food.y)) {
                    ctx.drawImage(iconOff, x * CELL_SIZE + iconOffset, y * CELL_SIZE + iconOffset, SVG_SIZE, SVG_SIZE);
                }
            }
        }

        // Draw Bulb (Food)
        ctx.font = `${CELL_SIZE * 0.8}px serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("ðŸ’¡", food.x * CELL_SIZE + CELL_SIZE/2, food.y * CELL_SIZE + CELL_SIZE/2 + 2);

        // Snake (Elec-On)
        snake.forEach(p => {
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(p.x * CELL_SIZE, p.y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
            if (iconOn.complete) {
                ctx.drawImage(iconOn, p.x * CELL_SIZE + iconOffset, p.y * CELL_SIZE + iconOffset, SVG_SIZE, SVG_SIZE);
            }
        });
    }

    function update() {
        if (isGameOver) return;

        if (nextDir === 'LEFT' && dx === 0) { dx = -1; dy = 0; }
        if (nextDir === 'RIGHT' && dx === 0) { dx = 1; dy = 0; }
        if (nextDir === 'UP' && dy === 0) { dx = 0; dy = -1; }
        if (nextDir === 'DOWN' && dy === 0) { dx = 0; dy = 1; }

        const head = {x: snake[0].x + dx, y: snake[0].y + dy};

        if (head.x < 0) head.x = COLS - 1;
        if (head.x >= COLS) head.x = 0;
        if (head.y < 0) head.y = ROWS - 1;
        if (head.y >= ROWS) head.y = 0;

        if (snake.some(p => p.x === head.x && p.y === head.y)) {
            gameOver();
            return;
        }

        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
            score++;
            food = { x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS) };
            tg.HapticFeedback.impactOccurred('medium');
        } else {
            snake.pop();
        }
    }

    function gameOver() {
        isGameOver = true;
        tg.HapticFeedback.notificationOccurred('warning');
        document.getElementById('final-score').innerText = score;
        document.getElementById('overlay').style.display = 'flex';
    }

    function reset() {
        snake = [{x: 5, y: 5}, {x: 4, y: 5}];
        dx = 1; dy = 0; nextDir = 'RIGHT';
        score = 0;
        isGameOver = false;
        document.getElementById('overlay').style.display = 'none';
        food = { x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS) };
    }

    function changeDir(d) { if(!isGameOver) nextDir = d; }

    window.addEventListener('keydown', e => {
        if(e.key === 'ArrowUp') changeDir('UP');
        if(e.key === 'ArrowDown') changeDir('DOWN');
        if(e.key === 'ArrowLeft') changeDir('LEFT');
        if(e.key === 'ArrowRight') changeDir('RIGHT');
    });

    setInterval(() => { update(); draw(); }, 200);
</script>
</body>
</html>
